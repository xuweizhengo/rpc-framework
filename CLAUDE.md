# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 在此代码仓库中工作时提供指导。

## 项目概述

本项目是一个企业级 RPC+MQ (远程过程调用+消息队列) 框架开发项目，基于 Java + Netty 技术栈。项目采用分阶段递进式开发方法，从基础通信框架开始，逐步构建完整的分布式服务框架生态。

## 技术架构方案

- **技术栈**：Java 8+ + Maven + Netty 4.1+ + Jackson + SLF4J
- **开发模式**：TDD (测试驱动开发) + 分层架构
- **部署架构**：模块化设计，支持容器化和云原生部署
- **扩展机制**：SPI + 类加载隔离，支持运行时热插拔

## 当前状态

项目已建立完整的文档体系和开发框架：

### 已完成内容
- **文档体系**：15份技术文档，涵盖架构设计、实现指南、最佳实践
- **分层架构设计**：API层-核心层-实现层三层防腐架构
- **协议设计**：12字节高效协议头 + 可扩展字段设计
- **开发指南**：7天快速上手实现路径
- **生产级考量**：监控、安全、性能、容错全覆盖

### 文档结构
- `docs/reference/api/` - API接口规范和架构设计
- `docs/reference/protocols/` - 通信协议和技术深度分析  
- `docs/reference/examples/` - 代码示例和实现指南
- `docs/reference/tools/` - 开发工具和变现指导
- `docs/reference/standards/` - 标准规范和高阶架构设计

## 核心开发原则

基于15份技术文档分析提炼的关键原则：

### 🔥 架构设计原则 (最高优先级)
1. **分层防腐原则**：API层零依赖，Core层业务逻辑与技术实现解耦
2. **协议演进能力**：扩展字段预留，版本协商机制，向后兼容性
3. **依赖治理机制**：类加载隔离，SPI扩展，模块热插拔

### 🔶 工程实践原则 (核心质量保障)
4. **可观测性设计**：分布式链路追踪、结构化日志、核心指标监控
5. **TDD与可测试性**：单元测试覆盖>70%，Mock隔离，契约驱动开发
6. **混沌工程实践**：故障注入、演练方案、韧性验证

### 🔴 性能优化原则 (生产级要求)
7. **零拷贝优化**：DirectBuffer、FileRegion、避免用户态拷贝
8. **对象池化机制**：Request/Response复用，连接池管理
9. **平台特定优化**：Epoll、SO_REUSEPORT、JVM调优

### 🛡️ 安全设计原则 (企业级合规)
10. **数据安全治理**：敏感数据脱敏、反序列化白名单、认证鉴权
11. **协议安全防护**：帧长度保护、魔数验证、资源限制

### 🔧 可扩展性原则 (长期演进能力)
12. **SPI扩展机制**：可插拔架构、标准化扩展点
13. **多环境适配**：容器检测、IPv6/K8s支持、服务网格集成

### ⚡ 容错设计原则 (高可用保障)
14. **优雅降级机制**：熔断器、多级缓存、健康检查
15. **资源保护策略**：连接泄漏检测、线程池保护、内存监控
16. **恢复机制设计**：重试策略、幂等性、断点续传

## RPC 框架分阶段目标

### 阶段1：基础通信框架 (7天实现)
- 协议编解码器实现
- 同步调用支持  
- 基础序列化 (JSON)
- 简单连接管理
- **验收标准**：单连接QPS>3000，99%延迟<50ms

### 阶段2：生产级增强 (预留)
- 异步调用支持
- 连接池管理
- 负载均衡算法
- 服务注册发现

### 阶段3：企业级特性 (预留)  
- 熔断降级
- 链路追踪
- 监控告警
- 安全认证

### 阶段4：生态集成 (预留)
- Spring Boot Starter
- 服务网格支持  
- 多协议兼容
- 管控平台

### 阶段5：商业化能力 (预留)
- 可视化管控台
- 性能分析工具
- 企业级安全
- 技术支持体系

## 测试驱动开发 (TDD) 工作流程

本项目推荐使用测试驱动开发方法，这是 Claude Code 最擅长的开发模式。请严格按照以下步骤执行：

### 1. 编写测试阶段
- **基于需求编写测试**：根据预期的输入/输出对编写详细的测试用例
- **明确TDD意图**：告诉 Claude 这是测试驱动开发，避免创建 mock 实现
- **覆盖所有场景**：包括正常情况、边界条件和错误处理
- **不编写实现**：在此阶段明确指示不要编写任何实现代码

### 2. 测试验证阶段
- **运行测试确认失败**：执行测试并确认它们按预期失败
- **分析失败原因**：确保测试失败是因为缺少实现，而不是测试本身有问题
- **提交测试代码**：在满意测试质量后，将测试提交到 git

### 3. 实现代码阶段
- **编写最小可行实现**：只编写通过测试所需的最少代码
- **不修改测试**：严格指示不要修改已经编写的测试
- **迭代改进**：运行测试 → 修复代码 → 再次运行测试，直到所有测试通过
- **代码质量检查**：可使用独立子智能体验证实现没有过度拟合测试

### 4. 完成阶段
- **最终验证**：确保所有测试通过且代码质量符合要求
- **提交实现代码**：将通过测试的实现代码提交到 git
- **文档更新**：更新相关文档和使用说明

### TDD 最佳实践
- 始终从测试开始，明确预期行为
- 保持测试简单、专注和易于理解
- 一次只关注一个功能或行为
- 确保测试具有明确的成功/失败标准
- 使用有意义的测试名称描述被测试的行为

## 开发实施要点

### 关键决策原则
1. **架构优先**：先确定分层架构和扩展点，再实现具体功能
2. **协议稳定**：协议设计一旦确定就不轻易修改，通过扩展字段演进
3. **测试驱动**：严格遵循TDD流程，先写测试再写实现
4. **监控内置**：从第一行代码开始就考虑监控和调试

### 代码质量标准
- 核心模块单元测试覆盖率 > 70%
- 所有public方法必须有JavaDoc注释
- 遵循Google Java代码规范
- 每个PR必须通过静态代码分析

### 性能基线要求
- 单连接QPS > 3,000 (4C8G环境)
- 99%请求延迟 < 50ms (局域网)
- 内存泄漏检测通过(1小时压测)
- 连接复用率 > 80%

### 开发环境配置
- 项目目录：`/home/ubuntu/project/rpc`
- JDK要求：1.8+
- Maven版本：3.6+
- IDE推荐：IntelliJ IDEA
- 必备插件：SonarLint, CheckStyle

### 文档维护
- 架构决策记录(ADR)随代码同步更新
- API文档使用JavaDoc自动生成
- 重要设计变更需更新相关技术文档
- 每个版本发布前更新CHANGELOG.md

### 调试和排查
- 启用详细的结构化日志
- 集成分布式链路追踪
- 预留JMX监控接口
- 支持运行时配置热更新